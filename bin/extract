#!/usr/bin/env node

var csv = require('csv');
var d3 = require('d3');

var db = require('../db');

var argv = process.argv.slice(2);
var ts_to = '' + new Date().getTime();
var ts_from = '1400000000000';
if (argv.length > 0) {
  ts_from = argv[0];
  if (argv.length > 1) {
    ts_to = argv[1];
  }
}

var stringifier = csv.stringify();

function pointify(d) {
  if (d.coordinates != null) {
    return d3.geo.centroid(d.coordinates);
  }
  return d3.geo.centroid(d.place.bounding_box);
}

var skip = 0;
var limit = 1000;
stringifier.pipe(process.stdout);
stringifier.write(['id', 'timestamp', 'longitude', 'latitude', 'lang', 'user', 'text']);
var iter = function() {
  db.getTweet({timestamp_ms:{$lt: ts_to, $gte: ts_from}}, {skip: skip, limit: limit}, function(err, res) {
    if (err != null) {
      throw err;
    }
    if (res.length == 0) {
      db.exit();
      return;
    }
    res.forEach(function(d) {
      var p = pointify(d);
      stringifier.write([d.id_str, d.timestamp_ms, p[0], p[1], d.lang, d.user.screen_name, d.text]);
    });
    skip += limit;
    iter();
  });
};
iter();
